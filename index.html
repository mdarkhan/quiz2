<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶ï‡ßÅ‡¶á‡¶ú</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@700&family=Noto+Sans+Bengali:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Authentic Islamic Green Palette */
            --primary-dark: #145A32;    /* Deep Forest Green */
            --primary-light: #27AE60;   /* Fresh Green */
            --accent-gold: #F1C40F;     /* Bright Gold */
            --text-white: #FFFFFF;
            --text-dark: #0B5345;
            
            --correct-color: #2E7D32;
            --wrong-color: #C0392B;

            --glass-bg: #FFFFFF;
            --shadow-soft: 0 10px 30px rgba(20, 90, 50, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans Bengali', sans-serif;
            background-color: #F4F8F5; 
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- STICKY TIMER --- */
        #sticky-timer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--primary-dark);
            color: var(--accent-gold);
            text-align: center;
            padding: 12px;
            font-weight: 700;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            display: flex;
            justify-content: center;
            gap: 10px;
            font-family: 'Courier New', monospace;
            font-size: 1.3rem;
            letter-spacing: 1px;
        }
        #sticky-timer.active { transform: translateY(0); }

        /* --- HEADER --- */
        header {
            width: 100%;
            background: linear-gradient(180deg, var(--primary-dark) 0%, #1E8449 100%);
            color: white;
            text-align: center;
            padding: 2.5rem 1rem 4rem 1rem;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            box-shadow: 0 4px 20px rgba(20, 90, 50, 0.2);
            position: relative;
            transition: all 0.5s ease;
        }

        header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 10px;
            background: var(--accent-gold);
            opacity: 0.7;
        }

        .bismillah {
            font-family: 'Amiri', serif;
            font-size: 1.8rem;
            color: var(--accent-gold);
            display: block;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 2px rgba(0,0,0,0.2);
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.95;
            background: rgba(255,255,255,0.15);
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
        }

        /* --- MAIN CONTAINER --- */
        main {
            width: 95%;
            max-width: 600px;
            margin-top: -3rem; /* Overlap header */
            z-index: 10;
            padding-bottom: 3rem;
            transition: margin-top 0.5s ease;
        }
        
        main.no-header {
            margin-top: 2rem;
        }

        .card {
            background: var(--glass-bg);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-soft);
            display: none;
            animation: fadeIn 0.4s ease-out;
            border-top: 4px solid var(--primary-light);
        }
        .card.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- FORM ELEMENTS --- */
        .section-title {
            color: var(--primary-dark);
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            border-bottom: 2px solid #E9F7EF;
            padding-bottom: 5px;
            margin-top: 1.5rem;
        }
        .section-title:first-child { margin-top: 0; }

        .grid-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        /* Three column grid for sheets if needed, or flex wrap */
        .sheet-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        .mode-select input { display: none; }
        .mode-select label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: white;
            border: 2px solid #E9F7EF;
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: 0.2s;
            text-align: center;
            height: 100%;
            color: #555;
            flex: 1;
            min-width: 80px;
        }

        .mode-select input:checked + label {
            border-color: var(--primary-light);
            background: #E9F7EF;
            color: var(--primary-dark);
            font-weight: 600;
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.15);
        }

        .mode-icon {
            font-size: 1.4rem;
            margin-bottom: 6px;
            color: var(--primary-light);
        }

        /* --- TIMER INPUT --- */
        .timer-config {
            background: #F4F8F5;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
            border: 1px dashed var(--primary-light);
        }
        .timer-config.show { display: block; }
        
        .timer-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #D5D8DC;
            border-radius: 6px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-dark);
        }
        .timer-input:focus { outline: none; border-color: var(--primary-light); }

        /* --- BUTTONS --- */
        .btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
            background: var(--primary-dark);
            color: white;
            margin-top: 20px;
        }
        .btn:hover { background: #0E4526; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { background: #95A5A6; cursor: not-allowed; }

        .btn-outline {
            background: white;
            border: 2px solid var(--primary-dark);
            color: var(--primary-dark);
        }
        .btn-outline:hover { background: #E9F7EF; }

        /* --- QUIZ UI --- */
        .q-number {
            font-size: 0.9rem;
            color: #7DCEA0;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        .q-text {
            font-size: 1.4rem;
            font-weight: 600;
            color: #1B2631;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .option-group { display: flex; flex-direction: column; gap: 10px; }
        
        .option-btn {
            position: relative;
            background: white;
            border: 1px solid #D5D8DC;
            border-radius: 8px;
            padding: 14px 18px;
            text-align: left;
            font-size: 1.05rem;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            color: #34495E;
        }
        
        .option-btn:hover { background: #FDFEFE; border-color: var(--primary-light); }
        
        .option-btn.selected {
            background: #E9F7EF;
            border-color: var(--primary-dark);
            color: var(--primary-dark);
            font-weight: 600;
        }
        
        .option-circle {
            width: 22px;
            height: 22px;
            border: 2px solid #BDC3C7;
            border-radius: 50%;
            margin-right: 15px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
        }
        
        .option-btn.selected .option-circle {
            border-color: var(--primary-dark);
            background: var(--primary-dark);
        }

        /* Multiple Choice Square */
        .option-btn.multi .option-circle { border-radius: 4px; }

        /* Feedback Colors */
        .option-btn.correct { background: #D4EFDF; border-color: var(--correct-color); color: var(--correct-color); }
        .option-btn.correct .option-circle { background: var(--correct-color); border-color: var(--correct-color); content: '‚úì'; }
        
        .option-btn.wrong { background: #FADBD8; border-color: var(--wrong-color); color: var(--wrong-color); }
        .option-btn.wrong .option-circle { background: var(--wrong-color); border-color: var(--wrong-color); }

        .explanation {
            background: #FEF9E7;
            border-left: 4px solid var(--accent-gold);
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            display: none;
            color: #7F6000;
        }

        /* --- RESULTS --- */
        .result-score {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: white;
            border: 6px solid var(--primary-light);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 0 auto 20px auto;
        }
        .score-val { font-size: 2.8rem; font-weight: 800; color: var(--primary-dark); line-height: 1; }
        .score-max { font-size: 1.1rem; color: #7F8C8D; }
        
        .review-card {
            background: white;
            border-bottom: 1px solid #ECF0F1;
            padding: 15px 0;
        }
        
        footer { margin-top: auto; padding: 20px; color: #95A5A6; font-size: 0.8rem; }
        
        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.9);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: var(--primary-dark);
            font-weight: 600;
        }

        @media(max-width:600px) {
            h1 { font-size: 2rem; }
            .grid-options { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- Sticky Timer -->
    <div id="sticky-timer">
        <span>‡¶∏‡¶Æ‡ßü ‡¶¨‡¶æ‡¶ï‡¶ø:</span>
        <span id="timer-val">00:00</span>
    </div>

    <!-- Loading -->
    <div id="loading-overlay">
        <div style="font-size:2rem; margin-bottom:10px;">‚åõ</div>
        <span>‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span>
    </div>

    <!-- Header -->
    <header id="main-header">
        <span class="bismillah">ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸ∞ŸÜŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê</span>
        <h1>‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶ï‡ßÅ‡¶á‡¶ú</h1>
        <span class="subtitle">‡¶ú‡ßç‡¶û‡¶æ‡¶®‡¶á ‡¶Ü‡¶≤‡ßã, ‡¶Ö‡¶ú‡ßç‡¶û‡¶§‡¶æ ‡¶Ö‡¶®‡ßç‡¶ß‡¶ï‡¶æ‡¶∞</span>
    </header>

    <main id="main-container">
        <!-- Home -->
        <div id="screen-home" class="card active">
            
            <!-- Source Selection -->
            <div class="section-title">‡¶¨‡¶ø‡¶∑‡ßü‡¶¨‡¶∏‡ßç‡¶§‡ßÅ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</div>
            <div id="sheet-list" class="sheet-options">
                <!-- Will be populated by JS -->
                <div>‡¶≤‡ßã‡¶°‡¶ø‡¶Ç...</div>
            </div>

            <!-- Mode Selection -->
            <div class="section-title">‡¶ï‡ßÅ‡¶á‡¶ú ‡¶Æ‡ßã‡¶°</div>
            <div class="grid-options">
                <div class="mode-select">
                    <input type="radio" name="mode" id="m-single" value="single" checked>
                    <label for="m-single">
                        <div class="mode-icon">üìö</div>
                        <strong>‡¶™‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡¶ü‡¶ø‡¶∏</strong>
                    </label>
                </div>
                <div class="mode-select">
                    <input type="radio" name="mode" id="m-full" value="full">
                    <label for="m-full">
                        <div class="mode-icon">üìù</div>
                        <strong>‡¶è‡¶ï‡ßç‡¶∏‡¶æ‡¶Æ</strong>
                    </label>
                </div>
            </div>

            <!-- Timer Selection -->
            <div class="section-title">‡¶∏‡¶Æ‡ßü (‡¶Ö‡¶™‡¶∂‡¶®‡¶æ‡¶≤)</div>
            <div class="grid-options">
                <div class="mode-select">
                    <input type="radio" name="timer" id="t-off" value="off" checked onclick="toggleTimer(false)">
                    <label for="t-off">‡¶∏‡¶Æ‡ßü ‡¶õ‡¶æ‡ßú‡¶æ</label>
                </div>
                <div class="mode-select">
                    <input type="radio" name="timer" id="t-on" value="on" onclick="toggleTimer(true)">
                    <label for="t-on">‡¶∏‡¶Æ‡ßü ‡¶∏‡ßá‡¶ü</label>
                </div>
            </div>
            
            <div id="timer-box" class="timer-config">
                <label style="display:block; margin-bottom:8px; font-size:0.9rem;">‡¶ï‡¶§ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü?</label>
                <input type="number" id="custom-min" class="timer-input" placeholder="‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£: ‡ßß‡ß¶" min="1">
            </div>

            <button onclick="startQuiz()" class="btn" id="start-btn">‡¶ï‡ßÅ‡¶á‡¶ú ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>

        <!-- Quiz -->
        <div id="screen-quiz" class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <span id="q-progress" class="q-number">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡ßß/‡ßß‡ß¶</span>
                <span id="q-source-badge" style="font-size:0.8rem; background:#E9F7EF; padding:3px 8px; border-radius:4px; color:var(--primary-dark);"></span>
            </div>
            
            <div id="q-container"></div>

            <div class="explanation" id="explanation">
                <strong style="color:var(--primary-dark)">‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ:</strong>
                <p id="exp-text" style="margin-top:5px; font-size:0.95rem;"></p>
            </div>

            <div style="margin-top:30px;">
                <button id="btn-submit" class="btn" onclick="submitAnswer()">‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <button id="btn-next" class="btn btn-outline" style="display:none;" onclick="nextQuestion()">‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®</button>
                <button id="btn-finish" class="btn" style="display:none;" onclick="finishQuiz()">‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
            </div>
        </div>

        <!-- Result -->
        <div id="screen-result" class="card">
            <h2 style="text-align:center; color:var(--primary-dark); margin-bottom:20px;">‡¶ï‡ßÅ‡¶á‡¶ú ‡¶´‡¶≤‡¶æ‡¶´‡¶≤</h2>
            <div class="result-score">
                <span id="score-val" class="score-val">0</span>
                <span id="score-max" class="score-max">/0</span>
            </div>
            <p id="feedback-msg" style="text-align:center; font-size:1.2rem; font-weight:600; margin-bottom:30px;"></p>
            <div id="review-list"></div>
            <button onclick="location.reload()" class="btn btn-outline" style="margin-top:20px;">‡¶π‡ßã‡¶Æ ‡¶™‡ßá‡¶ú‡ßá ‡¶´‡¶ø‡¶∞‡ßÅ‡¶®</button>
        </div>
    </main>

    <footer>
        &copy; ‡ß®‡ß¶‡ß®‡ß¨ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶ï‡ßÅ‡¶á‡¶ú | ‡¶™‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡¶ü‡¶ø‡¶∏ ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶§‡ßà‡¶∞‡¶ø
    </footer>

    <script>
        // --- CONFIG ---
        const SHEET_ID = '1UQkKKJ6QLJRyJqVRNyAcyKqtN1cmnbuIsGf9UtVSJyI';
        const KNOWN_SHEETS = ['‡¶¨‡¶á', '‡¶≤‡ßá‡¶ï‡¶ö‡¶æ‡¶∞', '‡¶∂‡ßÄ‡¶ü']; 

        let questions = [];
        let curIdx = 0;
        let score = 0;
        let userAns = [];
        let mode = 'single';
        let currentSheet = '';
        let timerInterval;

        // --- CORE FUNCTIONS ---
        function initApp() {
            try {
                const container = document.getElementById('sheet-list');
                
                let html = '';
                KNOWN_SHEETS.forEach((sheet, idx) => {
                    const checked = idx === 0 ? 'checked' : '';
                    html += `
                    <div class="mode-select">
                        <input type="radio" name="sheet" id="sheet-${idx}" value="${sheet}" ${checked}>
                        <label for="sheet-${idx}">
                            <div class="mode-icon">üìö</div>
                            <strong>${sheet}</strong>
                        </label>
                    </div>`;
                });
                container.innerHTML = html;
                document.getElementById('custom-min').value = "";
            } catch (e) {
                console.error("Initialization error:", e);
                document.getElementById('sheet-list').innerHTML = `<div style="color:red">Error initializing.</div>`;
            }
        }

        // Run immediately
        initApp();

        // --- FETCH & PARSE ---
        async function fetchQuestionsFromSheet(sheetName) {
            // Updated URL to ensure all data is returned and headers are handled
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}&headers=0`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("Network response was not ok");
                const text = await response.text();
                return parseCSV(text);
            } catch (error) {
                console.error("Error fetching sheet:", error);
                return null;
            }
        }

        // Simple CSV Parser to handle quotes and commas inside cells
        function parseCSV(str) {
            const arr = [];
            let quote = false;
            let row = [];
            let col = '';
            
            for (let c = 0; c < str.length; c++) {
                let cc = str[c], nc = str[c+1];
                
                if (cc === '"') {
                    if (quote && nc === '"') { 
                        col += '"'; 
                        c++; 
                    } else { 
                        quote = !quote; 
                    }
                } else if (cc === ',' && !quote) {
                    row.push(col); 
                    col = '';
                } else if ((cc === '\r' || cc === '\n') && !quote) {
                    if (cc === '\r' && nc === '\n') c++; // skip CRLF
                    row.push(col); 
                    col = '';
                    if (row.length > 0 && (row.length > 1 || row[0] !== '')) {
                        arr.push(row); 
                    }
                    row = [];
                } else {
                    col += cc;
                }
            }
            if (col || row.length > 0) { 
                row.push(col); 
                arr.push(row); 
            }
            return arr;
        }

        // Normalize Bangla Numerals to English
        function banglaToEnglish(str) {
            return str.replace(/[‡ß¶-‡ßØ]/g, d => "‡ß¶‡ßß‡ß®‡ß©‡ß™‡ß´‡ß¨‡ß≠‡ßÆ‡ßØ".indexOf(d));
        }

        function processRawData(rows, sheetName) {
            if(!rows || rows.length === 0) return [];
            
            return rows.map((row, i) => {
                const q = row[0];
                let opts = [];
                let correctStr = "";
                let exp = "";

                // Logic: Scan from end to find Answer Column
                // Regex matches: Digits (0-9), Bangla Digits (‡ß¶-‡ßØ), Space, Comma
                // This allows detecting the answer column even if it uses Bangla numbers
                const ansRegex = /^[\d\s,\u09E6-\u09EF]+$/;

                let correctIdx = -1;
                for (let j = row.length - 1; j > 0; j--) {
                    const val = row[j] ? row[j].toString().trim() : "";
                    if (val && ansRegex.test(val)) {
                        correctIdx = j;
                        break;
                    }
                }

                if (correctIdx === -1) return null;

                // Extract Options
                for(let k=1; k < correctIdx; k++) {
                    const o = row[k] ? row[k].toString().trim() : "";
                    // Filter out the sheet name if it appears in columns
                    if(o && o !== "" && o !== sheetName) opts.push(o);
                }

                // Normalize answer keys to English digits for parsing
                correctStr = banglaToEnglish(row[correctIdx].toString());
                exp = row[correctIdx + 1] || "";

                const corr = [];
                correctStr.split(/[, ]+/).forEach(c => {
                    const num = parseInt(c);
                    if(!isNaN(num) && num > 0) corr.push(num - 1);
                });

                return { id: i, q, opts, correct: corr, exp };
            }).filter(x => x && x.opts.length > 0);
        }

        // --- NAVIGATION ---
        function showScreen(id) {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.scrollTo(0,0);
        }

        function toggleTimer(show) {
            document.getElementById('timer-box').classList.toggle('show', show);
        }

        // --- QUIZ LOGIC ---
        async function startQuiz() {
            const sheetRadio = document.querySelector('input[name="sheet"]:checked');
            if(!sheetRadio) { alert("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡¶ø‡¶∑‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®"); return; }
            currentSheet = sheetRadio.value;

            // UI Loading
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('start-btn').disabled = true;

            // Fetch
            const rawRows = await fetchQuestionsFromSheet(currentSheet);
            
            // Process
            questions = processRawData(rawRows, currentSheet);

            // Hide Loading
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('start-btn').disabled = false;

            if(!questions || questions.length === 0) { 
                alert("‡¶è‡¶á ‡¶¨‡¶ø‡¶∑‡ßü‡ßá ‡¶ï‡ßã‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø ‡¶¨‡¶æ ‡¶∂‡ßÄ‡¶ü‡¶ü‡¶ø ‡¶´‡¶æ‡¶Å‡¶ï‡¶æ‡•§ ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§"); 
                return; 
            }

            // Shuffle
            questions.sort(() => Math.random() - 0.5);

            mode = document.querySelector('input[name="mode"]:checked').value;
            const timerOn = document.querySelector('input[name="timer"]:checked').value === 'on';
            
            if(timerOn) {
                const min = parseInt(document.getElementById('custom-min').value);
                if(!min || min < 1) { alert("‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®"); return; }
                startTimer(min * 60);
            }

            curIdx = 0;
            score = 0;
            userAns = new Array(questions.length).fill(null);
            
            document.getElementById('main-header').style.display = 'none';
            document.getElementById('main-container').classList.add('no-header');
            document.getElementById('q-source-badge').innerText = currentSheet;

            showScreen('screen-quiz');
            if(mode === 'single') renderSingle();
            else renderFull();
        }

        function startTimer(seconds) {
            const display = document.getElementById('timer-val');
            const bar = document.getElementById('sticky-timer');
            bar.classList.add('active');
            
            timerInterval = setInterval(() => {
                seconds--;
                const m = Math.floor(seconds / 60).toString().padStart(2,'0');
                const s = (seconds % 60).toString().padStart(2,'0');
                display.innerText = toBanglaNum(`${m}:${s}`);
                
                if(seconds <= 0) {
                    clearInterval(timerInterval);
                    alert("‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶∂‡ßá‡¶∑!");
                    finishQuiz();
                }
            }, 1000);
        }

        // --- RENDERERS ---
        function renderSingle() {
            const q = questions[curIdx];
            const isMulti = q.correct.length > 1;
            
            document.getElementById('q-progress').innerText = `‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ${toBanglaNum(curIdx+1)} / ${toBanglaNum(questions.length)}`;
            
            let html = `<div class="q-text">${q.q}</div>
                        <div style="font-size:0.9rem; color:#777; margin-bottom:10px; font-style:italic;">
                            ${isMulti ? "‡¶®‡ßã‡¶ü: ‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá" : ""}
                        </div>
                        <div class="option-group">`;
            
            q.opts.forEach((opt, i) => {
                html += `
                <div class="option-btn ${isMulti?'multi':''}" id="opt-${i}" onclick="selectOption(${i}, ${isMulti})">
                    <div class="option-circle"></div>
                    <span>${opt}</span>
                </div>`;
            });
            html += `</div>`;
            
            document.getElementById('q-container').innerHTML = html;
            document.getElementById('explanation').style.display = 'none';
            
            document.getElementById('btn-submit').style.display = 'block';
            document.getElementById('btn-next').style.display = 'none';
            document.getElementById('btn-finish').style.display = 'none';
        }

        function renderFull() {
            document.getElementById('q-progress').innerText = `‡¶Æ‡ßã‡¶ü ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®: ${toBanglaNum(questions.length)}`;
            document.getElementById('btn-submit').innerText = "‡¶ï‡ßÅ‡¶á‡¶ú ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®";
            document.getElementById('btn-next').style.display = 'none';

            let html = '';
            questions.forEach((q, idx) => {
                const isMulti = q.correct.length > 1;
                html += `<div style="margin-bottom:30px; border-bottom:1px solid #eee; padding-bottom:20px;">
                    <div class="q-number">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ${toBanglaNum(idx+1)}</div>
                    <div class="q-text" style="font-size:1.2rem; margin-bottom:10px;">${q.q}</div>
                    <div class="option-group">`;
                
                q.opts.forEach((opt, i) => {
                    html += `
                    <div class="option-btn ${isMulti?'multi':''}" id="q${idx}-opt${i}" onclick="selectOptionFull(${idx}, ${i}, ${isMulti})">
                        <div class="option-circle"></div>
                        <span>${opt}</span>
                    </div>`;
                });
                html += `</div></div>`;
            });
            document.getElementById('q-container').innerHTML = html;
        }

        // --- INTERACTIONS ---
        let currentSelection = [];
        
        function selectOption(idx, isMulti) {
            if(document.getElementById('btn-submit').style.display === 'none') return;

            if(isMulti) {
                if(currentSelection.includes(idx)) currentSelection = currentSelection.filter(i=>i!==idx);
                else currentSelection.push(idx);
            } else {
                currentSelection = [idx];
            }
            updateUISelection();
        }

        function updateUISelection() {
            document.querySelectorAll('.option-btn').forEach((el, i) => {
                const idx = parseInt(el.id.split('-')[1]);
                if(currentSelection.includes(idx)) el.classList.add('selected');
                else el.classList.remove('selected');
            });
        }

        function selectOptionFull(qIdx, oIdx, isMulti) {
            let ans = userAns[qIdx] || [];
            if(isMulti) {
                if(ans.includes(oIdx)) ans = ans.filter(i=>i!==oIdx);
                else ans.push(oIdx);
            } else {
                ans = [oIdx];
            }
            userAns[qIdx] = ans;
            
            const parent = document.getElementById(`q${qIdx}-opt${oIdx}`).parentNode;
            Array.from(parent.children).forEach((el, i) => {
                if(ans.includes(i)) el.classList.add('selected');
                else el.classList.remove('selected');
            });
        }

        // --- SUBMIT ---
        function submitAnswer() {
            if(mode === 'full') {
                if(confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡ßÅ‡¶á‡¶ú ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
                    finishQuiz();
                }
                return;
            }

            if(currentSelection.length === 0) return;
            
            const q = questions[curIdx];
            userAns[curIdx] = [...currentSelection];
            
            q.opts.forEach((_, i) => {
                const el = document.getElementById(`opt-${i}`);
                el.classList.remove('selected');
                if(q.correct.includes(i)) el.classList.add('correct');
                else if(currentSelection.includes(i)) el.classList.add('wrong');
            });

            document.getElementById('exp-text').innerText = q.exp || "‡¶ï‡ßã‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶®‡ßá‡¶á‡•§";
            document.getElementById('explanation').style.display = 'block';

            document.getElementById('btn-submit').style.display = 'none';
            if(curIdx < questions.length - 1) {
                document.getElementById('btn-next').style.display = 'block';
            } else {
                document.getElementById('btn-finish').style.display = 'block';
            }
            
            currentSelection = [];
        }

        function nextQuestion() {
            curIdx++;
            renderSingle();
        }

        function finishQuiz() {
            clearInterval(timerInterval);
            document.getElementById('sticky-timer').classList.remove('active');
            document.getElementById('main-header').style.display = 'block'; 
            document.getElementById('main-container').classList.remove('no-header');
            
            score = 0;
            questions.forEach((q, i) => {
                const u = (userAns[i] || []).sort().toString();
                const c = q.correct.sort().toString();
                if(u === c) score++;
            });

            showScreen('screen-result');
            document.getElementById('score-val').innerText = toBanglaNum(score);
            document.getElementById('score-max').innerText = "/" + toBanglaNum(questions.length);
            
            const pct = (score / questions.length) * 100;
            let msg = "";
            if(pct >= 80) msg = "‡¶Æ‡¶æ‡¶∂‡¶æ‡¶Ü‡¶≤‡ßç‡¶≤‡¶æ‡¶π! ‡¶ö‡¶Æ‡ßé‡¶ï‡¶æ‡¶∞ ‡¶π‡ßü‡ßá‡¶õ‡ßá";
            else if(pct >= 50) msg = "‡¶Ü‡¶≤‡¶π‡¶æ‡¶Æ‡¶¶‡ßÅ‡¶≤‡¶ø‡¶≤‡ßç‡¶≤‡¶æ‡¶π, ‡¶≠‡¶æ‡¶≤‡ßã ‡¶™‡ßç‡¶∞‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ";
            else msg = "‡¶Ü‡¶∞‡¶ì ‡¶™‡ßú‡¶æ‡¶∂‡ßã‡¶®‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®";
            document.getElementById('feedback-msg').innerText = msg;

            let revHtml = "";
            questions.forEach((q, i) => {
                const u = userAns[i] || [];
                const isCorr = JSON.stringify(u.sort()) === JSON.stringify(q.correct.sort());
                const uText = u.map(idx => q.opts[idx]).join(", ");
                const cText = q.correct.map(idx => q.opts[idx]).join(", ");
                
                revHtml += `
                <div class="review-card">
                    <div style="font-weight:bold; margin-bottom:5px; color:#145A32;">${toBanglaNum(i+1)}. ${q.q}</div>
                    <div style="font-size:0.9rem;">
                        ${isCorr ? 
                            `<span style="color:green; font-weight:bold;">‚úî ‡¶∏‡¶†‡¶ø‡¶ï</span>` : 
                            `<span style="color:#C0392B; font-weight:bold;">‚úò ‡¶≠‡ßÅ‡¶≤ (‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞: ${uText||'‡¶´‡¶æ‡¶Å‡¶ï‡¶æ'})</span>`
                        }
                    </div>
                    <div style="font-size:0.9rem; color:#555; margin-top:5px;">‡¶∏‡¶†‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞: <b>${cText}</b></div>
                    <div style="background:#F4F8F5; padding:8px; margin-top:5px; font-size:0.85rem; border-radius:4px;">${q.exp}</div>
                </div>`;
            });
            document.getElementById('review-list').innerHTML = revHtml;
        }

        // --- UTILS ---
        function toBanglaNum(n) {
            return n.toString().replace(/\d/g, d => "‡ß¶‡ßß‡ß®‡ß©‡ß™‡ß´‡ß¨‡ß≠‡ßÆ‡ßØ"[d]);
        }
    </script>
</body>
</html>
